<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸æŒ‘æˆ° - å½ˆçª—è§£æç‰ˆ</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --accent-color: #9013fe;
            --success-color: #7ed321;
            --error-color: #d0021b;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden; /* é˜²æ­¢æ‰‹æ©Ÿå·¦å³æ»‘å‹• */
        }

        .container {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 20px;
        }

        /* é¸å–®æŒ‰éˆ• */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .mode-btn {
            background-color: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 20px;
            font-size: 1.3rem;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            touch-action: manipulation;
        }

        .mode-btn.mixed-mode {
            grid-column: span 2;
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #fdf8ff;
        }

        .mode-btn:active { transform: scale(0.98); background-color: #eee; }
        .mode-btn.mixed-mode:active { background-color: var(--accent-color); color: white; }

        /* ç·´ç¿’å€ */
        #practice-area { display: none; }

        .problem-display {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 20px 0;
            color: #2c3e50;
            white-space: nowrap;
        }
        
        @media (max-width: 400px) { .problem-display { font-size: 2rem; } }

        input[type="number"] {
            width: 140px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            outline: none;
            -moz-appearance: textfield;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus { border-color: var(--primary-color); }

        .action-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #d48e15;
            width: 100%;
            max-width: 280px;
        }

        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        /* ç°¡æ˜“çµæœæç¤º (ä¸ä½”ç©ºé–“) */
        #mini-feedback {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            height: 30px; /* å›ºå®šé«˜åº¦é¿å…è·³å‹• */
        }
        
        /* æŸ¥çœ‹è©³è§£æŒ‰éˆ• (é è¨­éš±è—) */
        .explain-btn {
            background-color: #fff;
            border: 2px solid #999;
            color: #666;
            padding: 10px 20px;
            border-radius: 30px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: none; /* é è¨­ä¸é¡¯ç¤º */
        }
        .explain-btn:active { background-color: #eee; }

        /* ============================== */
        /*       å½ˆå‡ºè¦–çª— (Modal) æ¨£å¼     */
        /* ============================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            z-index: 9999; /* æœ€ä¸Šå±¤ */
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(3px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ (iPadä¸Šæ•ˆæœå¾ˆå¥½) */
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #fff;
            width: 85%;
            max-width: 500px;
            max-height: 80vh; /* é¿å…è¶…å‡ºè¢å¹•é«˜åº¦ */
            overflow-y: auto; /* å…§å®¹å¤ªé•·å¯æ²å‹• */
            border-radius: 20px;
            padding: 25px;
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆè·³ç‰¹æ•ˆ */
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: left;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .close-modal-btn {
            background: #eee;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--accent-color);
            margin-bottom: 15px;
        }

        .step-highlight {
            background-color: #fff3cd;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
            color: #856404;
        }
        
        .back-btn {
            background: none; border: none; color: #999; margin-top: 20px;
            font-size: 1rem; text-decoration: underline; cursor: pointer;
        }

    </style>
</head>
<body>

<!-- ä¸»å®¹å™¨ -->
<div class="container">
    <!-- é¦–é é¸å–® -->
    <div id="home-menu">
        <h1>ğŸ§® æ•¸å­¸å¤§å†’éšª</h1>
        <p>é¸æ“‡æŒ‘æˆ°æ¨¡å¼ï¼š</p>
        <div class="menu-grid">
            <button class="mode-btn" onclick="startPractice('add')">â• åŠ æ³•</button>
            <button class="mode-btn" onclick="startPractice('subtract')">â– æ¸›æ³•</button>
            <button class="mode-btn" onclick="startPractice('multiply')">âœ–ï¸ ä¹˜æ³•</button>
            <button class="mode-btn" onclick="startPractice('divide')">â— é™¤æ³•</button>
            <button class="mode-btn mixed-mode" onclick="startPractice('mixed')">ğŸš€ æ··åˆé‹ç®—æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- ç·´ç¿’å€ -->
    <div id="practice-area">
        <h2 id="mode-title">ç·´ç¿’æ¨¡å¼</h2>
        
        <div class="problem-display" id="problem-text">
            <!-- é¡Œç›® -->
        </div>

        <div>
            <input type="number" id="answer-input" placeholder="?" pattern="[0-9]*" inputmode="numeric">
        </div>

        <!-- ç°¡å–®çš„çµæœåé¥‹æ–‡å­— -->
        <div id="mini-feedback"></div>

        <button class="action-btn" id="check-btn" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ</button>
        
        <!-- é€™æ˜¯è§¸ç™¼å½ˆçª—çš„æŒ‰éˆ• -->
        <button class="explain-btn" id="explain-trigger" onclick="openModal()">ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯</button>

        <button class="action-btn" id="next-btn" onclick="generateProblem()" style="display:none; background-color: var(--primary-color);">ä¸‹ä¸€é¡Œ âœ</button>

        <br>
        <button class="back-btn" onclick="goHome()">å›ä¸»é¸å–®</button>
    </div>
</div>

<!-- å½ˆå‡ºè¦–çª— (Modal) çµæ§‹ -->
<div id="explanation-modal" class="modal-overlay" onclick="closeModalOutside(event)">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">ğŸ“ è§£é¡Œæ€è·¯</span>
            <button class="close-modal-btn" onclick="closeModal()">âœ•</button>
        </div>
        <div id="modal-body">
            <!-- é€™è£¡çš„å…§å®¹æœƒé€é JavaScript å‹•æ…‹å¡«å…¥ -->
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="action-btn" onclick="closeModal()" style="padding: 10px 30px; font-size: 1rem; width:auto;">æˆ‘çŸ¥é“äº†ï¼</button>
        </div>
    </div>
</div>

<script>
    let currentMode = '';
    let num1 = 0, num2 = 0;
    let mixedProblem = null;
    let correctAnswer = 0;
    let currentExplanationHTML = ''; // æš«å­˜è§£é¡Œæ€è·¯çš„ HTML

    function startPractice(mode) {
        currentMode = mode;
        document.getElementById('home-menu').style.display = 'none';
        document.getElementById('practice-area').style.display = 'block';
        
        const titles = {
            'add': 'åŠ æ³•ç·´ç¿’', 'subtract': 'æ¸›æ³•ç·´ç¿’',
            'multiply': 'ä¹˜æ³•ç·´ç¿’', 'divide': 'é™¤æ³•ç·´ç¿’',
            'mixed': 'æ··åˆé‹ç®— (å…ˆä¹˜é™¤å¾ŒåŠ æ¸›)'
        };
        document.getElementById('mode-title').innerText = titles[mode];
        generateProblem();
    }

    function goHome() {
        document.getElementById('practice-area').style.display = 'none';
        document.getElementById('home-menu').style.display = 'block';
        resetUI();
    }

    function generateProblem() {
        resetUI();
        const input = document.getElementById('answer-input');
        input.value = '';
        input.focus(); // è®“ iPad éµç›¤å½ˆå‡º

        if (currentMode === 'mixed') {
            generateMixedProblem();
        } else {
            generateBasicProblem();
        }
    }

    function generateBasicProblem() {
        switch(currentMode) {
            case 'add':
                num1 = r(10, 99); num2 = r(10, 99); 
                correctAnswer = num1 + num2;
                setProblem(`${num1} + ${num2} = ?`);
                break;
            case 'subtract':
                num1 = r(10, 99); num2 = r(1, num1-1);
                correctAnswer = num1 - num2;
                setProblem(`${num1} - ${num2} = ?`);
                break;
            case 'multiply':
                num1 = r(2, 9); num2 = r(2, 9);
                correctAnswer = num1 * num2;
                setProblem(`${num1} Ã— ${num2} = ?`);
                break;
            case 'divide':
                num2 = r(2, 9); correctAnswer = r(2, 9);
                num1 = num2 * correctAnswer;
                setProblem(`${num1} Ã· ${num2} = ?`);
                break;
        }
    }

    function generateMixedProblem() {
        const type = Math.floor(Math.random() * 4);
        let n1, n2, n3;

        if (type === 0) { // A + B x C
            n2 = r(2,9); n3 = r(2,9); n1 = r(1,20);
            correctAnswer = n1 + (n2 * n3);
            mixedProblem = {
                text: `${n1} + ${n2} Ã— ${n3} = ?`,
                html: generateStepHTML('å…ˆç®—ä¹˜æ³•ï¼Œå†ç®—åŠ æ³•', `${n2} Ã— ${n3} = ${n2*n3}`, `${n1} + ${n2*n3} = ${correctAnswer}`)
            };
        } else if (type === 1) { // A - B x C
            n2 = r(2,5); n3 = r(2,5);
            let m = n2 * n3;
            n1 = m + r(5,20);
            correctAnswer = n1 - m;
            mixedProblem = {
                text: `${n1} - ${n2} Ã— ${n3} = ?`,
                html: generateStepHTML('é›–ç„¶æ¸›è™Ÿåœ¨å‰é¢ï¼Œä½†è¦å…ˆç®—å¾Œé¢çš„ä¹˜æ³•', `${n2} Ã— ${n3} = ${m}`, `${n1} - ${m} = ${correctAnswer}`)
            };
        } else if (type === 2) { // A + B / C
            n3 = r(2,9); let q = r(2,9); n2 = n3 * q; n1 = r(1,20);
            correctAnswer = n1 + q;
            mixedProblem = {
                text: `${n1} + ${n2} Ã· ${n3} = ?`,
                html: generateStepHTML('è¨˜å¾—å£è¨£ï¼šå…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸›', `${n2} Ã· ${n3} = ${q}`, `${n1} + ${q} = ${correctAnswer}`)
            };
        } else { // A - B / C
            n3 = r(2,9); let q = r(2,9); n2 = n3 * q; n1 = q + r(5,20);
            correctAnswer = n1 - q;
            mixedProblem = {
                text: `${n1} - ${n2} Ã· ${n3} = ?`,
                html: generateStepHTML('çœ‹åˆ°é™¤è™Ÿäº†å—ï¼Ÿå„ªå…ˆè™•ç†å®ƒ', `${n2} Ã· ${n3} = ${q}`, `${n1} - ${q} = ${correctAnswer}`)
            };
        }
        setProblem(mixedProblem.text);
    }

    // è¼”åŠ©ï¼šéš¨æ©Ÿæ•¸
    function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    
    // è¼”åŠ©ï¼šè¨­å®šé¡Œç›®æ–‡å­—
    function setProblem(text) { document.getElementById('problem-text').innerText = text; }

    // è¼”åŠ©ï¼šç”Ÿæˆæ··åˆé‹ç®— HTML
    function generateStepHTML(hint, s1, s2) {
        return `
            <div style="color:#666; margin-bottom:10px;">ğŸ’¡ æç¤ºï¼š${hint}</div>
            <div class="step-box">
                <strong>Step 1:</strong><br> ${s1}
            </div>
            <div class="step-box" style="border-left-color: var(--success-color);">
                <strong>Step 2:</strong><br> ${s2}
            </div>
        `;
    }

    function checkAnswer() {
        const userVal = document.getElementById('answer-input').value;
        if(userVal === '') { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
        const userAnswer = parseInt(userVal);
        const feedback = document.getElementById('mini-feedback');
        
        // æº–å‚™è§£é¡Œæ€è·¯å…§å®¹ (ä½†å…ˆä¸å½ˆå‡º)
        prepareExplanation();

        if (userAnswer === correctAnswer) {
            feedback.innerHTML = "<span style='color:green'>ğŸ‰ ç­”å°äº†ï¼å¤ªæ£’äº†ï¼</span>";
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            // ç­”å°æ™‚ï¼Œé¡¯ç¤ºæ€è·¯æŒ‰éˆ•è®“æƒ³çœ‹çš„äººçœ‹
            document.getElementById('explain-trigger').style.display = 'inline-block'; 
        } else {
            feedback.innerHTML = "<span style='color:red'>ğŸ’ª å·®ä¸€é»é»ï¼Œçœ‹çœ‹è§£é¡Œæ€è·¯å§ï¼</span>";
            // ç­”éŒ¯æ™‚ï¼Œç›´æ¥é¡¯ç¤ºæ€è·¯æŒ‰éˆ•ï¼Œä¸¦å¼·çƒˆå»ºè­°é»æ“Š
            document.getElementById('explain-trigger').style.display = 'inline-block';
            document.getElementById('explain-trigger').innerText = "ğŸ’¡ é»æˆ‘çœ‹æ€éº¼ç®—";
            
            // é¸é …ï¼šå¦‚æœæ‚¨å¸Œæœ›ç­”éŒ¯ç›´æ¥å½ˆå‡ºï¼Œå¯ä»¥æŠŠä¸‹é¢é€™è¡Œè¨»è§£æ‰“é–‹
            // openModal(); 
        }
    }

    function resetUI() {
        document.getElementById('mini-feedback').innerHTML = "";
        document.getElementById('check-btn').style.display = 'inline-block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('explain-trigger').style.display = 'none';
        document.getElementById('explain-trigger').innerText = "ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯";
    }

    // æº–å‚™è§£é¡Œå…§å®¹ HTML
    function prepareExplanation() {
        if (currentMode === 'mixed') {
            currentExplanationHTML = mixedProblem.html;
        } else {
            // åŸºç¤é‹ç®—è§£æ
            let logic = "";
            if(currentMode === 'add') logic = `æŠŠ ${num1} å’Œ ${num2} åˆèµ·ä¾†ã€‚`;
            if(currentMode === 'subtract') logic = `å¾ ${num1} æ‹¿èµ° ${num2}ã€‚`;
            if(currentMode === 'multiply') logic = `${num1} å€‹ ${num2} ç›¸åŠ ã€‚`;
            if(currentMode === 'divide') logic = `${num1} åˆ†æˆ ${num2} ä»½ï¼Œæ¯ä»½æœ‰å¤šå°‘ï¼Ÿ`;
            
            currentExplanationHTML = `
                <p style="font-size:1.1rem;">${logic}</p>
                <div class="step-box">
                    ç®—å¼ï¼š ${document.getElementById('problem-text').innerText.replace('?', correctAnswer)}
                </div>
            `;
        }
    }

    // ===========================
    //      å½ˆå‡ºè¦–çª—æ§åˆ¶é‚è¼¯
    // ===========================
    
    function openModal() {
        // 1. æŠŠå…§å®¹å¡«å…¥ Modal
        document.getElementById('modal-body').innerHTML = currentExplanationHTML;
        
        // 2. é¡¯ç¤º Modal
        const modal = document.getElementById('explanation-modal');
        modal.style.display = 'flex'; // å…ˆè¨­ç‚º flex è®“å®ƒå­˜åœ¨æ–¼ DOM
        
        // 3. å¼·åˆ¶é‡ç¹ªå¾ŒåŠ  active class ä»¥è§¸ç™¼ CSS transition
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);

        // 4. æ”¶èµ· iPad éµç›¤ (UX å„ªåŒ–)
        document.getElementById('answer-input').blur();
    }

    function closeModal() {
        const modal = document.getElementById('explanation-modal');
        modal.classList.remove('active');
        
        // ç­‰å‹•ç•«çµæŸå†éš±è— display
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // é»æ“ŠèƒŒæ™¯é—œé–‰
    function closeModalOutside(event) {
        if (event.target.id === 'explanation-modal') {
            closeModal();
        }
    }

</script>

</body>
</html>
