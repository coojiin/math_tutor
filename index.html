<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸æŒ‘æˆ° - é€²éšæ··åˆé‹ç®—ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --accent-color: #9013fe;
            --success-color: #7ed321;
            --error-color: #d0021b;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* è¨ˆåˆ†æ¿æ¨£å¼ */
        .score-board {
            display: flex;
            justify-content: space-between;
            background-color: #fdf8e4;
            border: 2px solid #f5a623;
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #d48e15;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }

        .score-val {
            font-size: 1.5rem;
            color: #333;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .mode-btn {
            background-color: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mode-btn span.high-score {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }

        .mode-btn.mixed-mode {
            grid-column: span 2;
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #fdf8ff;
        }

        .mode-btn:active {
            transform: scale(0.98);
            background-color: #eee;
        }

        .mode-btn.mixed-mode:active {
            background-color: var(--accent-color);
            color: white;
        }

        #practice-area {
            display: none;
        }

        .problem-display {
            font-size: 2.5rem;
            /* ç¨å¾®èª¿å°ä»¥é©æ‡‰é•·ç®—å¼ */
            font-weight: bold;
            margin: 10px 0 20px 0;
            color: #2c3e50;
            white-space: nowrap;
        }

        @media (max-width: 400px) {
            .problem-display {
                font-size: 1.8rem;
            }
        }

        input[type="number"] {
            width: 140px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            outline: none;
            -moz-appearance: textfield;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input:focus {
            border-color: var(--primary-color);
        }

        .action-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #d48e15;
            width: 100%;
            max-width: 280px;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        #mini-feedback {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            height: 30px;
        }

        .explain-btn {
            background-color: #fff;
            border: 2px solid #999;
            color: #666;
            padding: 10px 20px;
            border-radius: 30px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(3px);
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #fff;
            width: 85%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 20px;
            padding: 25px;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            text-align: left;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .close-modal-btn {
            background: #eee;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--accent-color);
            margin-bottom: 15px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #999;
            margin-top: 20px;
            font-size: 1rem;
            text-decoration: underline;
            cursor: pointer;
        }

        @keyframes pop {
            50% {
                transform: scale(1.2);
            }
        }

        .new-record-anim {
            animation: pop 0.3s ease-in-out;
            color: #d0021b;
        }

        /* Virtual Keypad Styles */
        .keypad-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 320px;
            margin: 20px auto 0;
        }

        .key-btn {
            background-color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: #555;
            box-shadow: 0 4px 0 #e0e0e0;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .key-btn:active,
        .key-btn.pressed {
            transform: translateY(4px);
            box-shadow: none;
            background-color: #f0f0f0;
        }

        .key-btn.action-key {
            background-color: #e3f2fd;
            color: var(--primary-color);
            box-shadow: 0 4px 0 #bbdefb;
        }

        .key-btn.action-key:active,
        .key-btn.action-key.pressed {
            background-color: #bbdefb;
        }

        .key-btn.enter-key {
            grid-column: span 3;
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 4px 0 #64a81a;
        }

        .key-btn.enter-key:active,
        .key-btn.enter-key.pressed {
            background-color: #64a81a;
            box-shadow: none;
        }

        /* Responsive Adjustments */
        @media (min-width: 600px) {
            .keypad-container {
                gap: 20px;
                max-width: 380px;
            }

            .key-btn {
                font-size: 1.8rem;
                padding: 20px 0;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- é¦–é é¸å–® -->
        <div id="home-menu">
            <h1>ğŸ† æ•¸å­¸æŒ‘æˆ°è³½</h1>
            <p>æ‰“ç ´ç´€éŒ„ï¼Œæˆç‚ºæ•¸å­¸å°åšå£«ï¼</p>
            <div class="menu-grid">
                <button class="mode-btn" onclick="startPractice('add')">â• åŠ æ³• <span class="high-score" id="score-add">ç´€éŒ„:
                        0</span></button>
                <button class="mode-btn" onclick="startPractice('subtract')">â– æ¸›æ³• <span class="high-score"
                        id="score-subtract">ç´€éŒ„: 0</span></button>
                <button class="mode-btn" onclick="startPractice('multiply')">âœ–ï¸ ä¹˜æ³• <span class="high-score"
                        id="score-multiply">ç´€éŒ„: 0</span></button>
                <button class="mode-btn" onclick="startPractice('divide')">â— é™¤æ³• <span class="high-score"
                        id="score-divide">ç´€éŒ„: 0</span></button>
                <button class="mode-btn mixed-mode" onclick="startPractice('mixed')">ğŸš€ æ··åˆé‹ç®— (é€²éš) <span
                        class="high-score" id="score-mixed">ç´€éŒ„: 0</span></button>
            </div>
        </div>

        <!-- ç·´ç¿’å€ -->
        <div id="practice-area">
            <div class="score-board">
                <div class="score-item">
                    <span>âœ¨ æœ¬æ¬¡å¾—åˆ†</span>
                    <span class="score-val" id="current-score">0</span>
                </div>
                <div class="score-item" style="text-align:right;">
                    <span>ğŸ† æœ€é«˜ç´€éŒ„</span>
                    <span class="score-val" id="best-score">0</span>
                </div>
            </div>

            <h3 id="mode-title" style="color:#999; margin:0; font-size:1rem;">ç·´ç¿’æ¨¡å¼</h3>
            <div class="problem-display" id="problem-text"></div>
            <div><input type="number" id="answer-input" placeholder="?" readonly></div>

            <!-- Virtual Keypad -->
            <div class="keypad-container">
                <button class="key-btn" onclick="appendNumber(7)">7</button>
                <button class="key-btn" onclick="appendNumber(8)">8</button>
                <button class="key-btn" onclick="appendNumber(9)">9</button>
                <button class="key-btn" onclick="appendNumber(4)">4</button>
                <button class="key-btn" onclick="appendNumber(5)">5</button>
                <button class="key-btn" onclick="appendNumber(6)">6</button>
                <button class="key-btn" onclick="appendNumber(1)">1</button>
                <button class="key-btn" onclick="appendNumber(2)">2</button>
                <button class="key-btn" onclick="appendNumber(3)">3</button>
                <button class="key-btn action-key" onclick="clearInput()">C</button>
                <button class="key-btn" onclick="appendNumber(0)">0</button>
                <button class="key-btn action-key" onclick="backspace()">âŒ«</button>
                <button class="key-btn enter-key" id="keypad-enter" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ</button>
            </div>

            <div id="mini-feedback"></div>
            <!-- Original check-btn hidden as we have one in keypad now, but keeping logic compatible -->
            <button class="action-btn" id="check-btn" onclick="checkAnswer()" style="display:none;">é€å‡ºç­”æ¡ˆ</button>
            <button class="explain-btn" id="explain-trigger" onclick="openModal()">ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯</button>
            <button class="action-btn" id="next-btn" onclick="generateProblem()"
                style="display:none; background-color: var(--primary-color);">ä¸‹ä¸€é¡Œ âœ</button>
            <br>
            <button class="back-btn" onclick="goHome()">çµæŸç·´ç¿’ (å›ä¸»é¸å–®)</button>
        </div>
    </div>

    <div id="explanation-modal" class="modal-overlay" onclick="closeModalOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">ğŸ“ è§£é¡Œæ€è·¯</span>
                <button class="close-modal-btn" onclick="closeModal()">âœ•</button>
            </div>
            <div id="modal-body"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="action-btn" onclick="closeModal()"
                    style="padding: 10px 30px; font-size: 1rem; width:auto;">æˆ‘çŸ¥é“äº†ï¼</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = '';
        let num1 = 0, num2 = 0;
        let mixedProblem = null;
        let correctAnswer = 0;
        let currentExplanationHTML = '';
        let currentSessionScore = 0;
        let highScores = { 'add': 0, 'subtract': 0, 'multiply': 0, 'divide': 0, 'mixed': 0 };

        window.onload = function () {
            loadHighScores();
            updateMenuScores();
            initTouchFeedback();
        };
        function loadHighScores() { const saved = localStorage.getItem('mathTutorHighScores'); if (saved) highScores = JSON.parse(saved); }
        function saveHighScores() { localStorage.setItem('mathTutorHighScores', JSON.stringify(highScores)); }
        function updateMenuScores() { for (const [m, s] of Object.entries(highScores)) { const el = document.getElementById(`score-${m}`); if (el) el.innerText = `ç´€éŒ„: ${s}`; } }

        function initTouchFeedback() {
            const keys = document.querySelectorAll('.key-btn');
            keys.forEach(btn => {
                btn.addEventListener('touchstart', function (e) {
                    // e.preventDefault(); // Optional: might prevent click if not careful, but good for stopping scroll on keys
                    this.classList.add('pressed');
                }, { passive: true });

                btn.addEventListener('touchend', function (e) {
                    this.classList.remove('pressed');
                });

                // Also handle touchcancel just in case
                btn.addEventListener('touchcancel', function (e) {
                    this.classList.remove('pressed');
                });
            });
        }

        function startPractice(mode) {
            currentMode = mode;
            currentSessionScore = 0;
            document.getElementById('home-menu').style.display = 'none';
            document.getElementById('practice-area').style.display = 'block';
            const titles = { 'add': 'åŠ æ³•ç·´ç¿’', 'subtract': 'æ¸›æ³•ç·´ç¿’', 'multiply': 'ä¹˜æ³•ç·´ç¿’', 'divide': 'é™¤æ³•ç·´ç¿’', 'mixed': 'æ··åˆé‹ç®— (éš¨æ©Ÿé¡Œå‹)' };
            document.getElementById('mode-title').innerText = titles[mode];
            updateScoreUI();
            generateProblem();
        }

        function updateScoreUI() {
            const currEl = document.getElementById('current-score');
            currEl.innerText = currentSessionScore;
            document.getElementById('best-score').innerText = highScores[currentMode];
            if (currentSessionScore > highScores[currentMode] && highScores[currentMode] > 0) currEl.classList.add('new-record-anim');
            else currEl.classList.remove('new-record-anim');
        }

        function goHome() {
            document.getElementById('practice-area').style.display = 'none';
            document.getElementById('home-menu').style.display = 'block';
            updateMenuScores();
            resetUI();
        }

        function generateProblem() {
            resetUI();
            const input = document.getElementById('answer-input');
            input.value = '';
            // input.focus(); // Removed focus to prevent keyboard
            if (currentMode === 'mixed') generateMixedProblem();
            else generateBasicProblem();
        }

        // åŸºç¤å››å‰‡é‹ç®— (ä¿æŒä¸è®Š)
        function generateBasicProblem() {
            switch (currentMode) {
                case 'add': num1 = r(10, 99); num2 = r(10, 99); correctAnswer = num1 + num2; setProblem(`${num1} + ${num2} = ?`); break;
                case 'subtract': num1 = r(10, 99); num2 = r(1, num1 - 1); correctAnswer = num1 - num2; setProblem(`${num1} - ${num2} = ?`); break;
                case 'multiply': num1 = r(2, 9); num2 = r(2, 9); correctAnswer = num1 * num2; setProblem(`${num1} Ã— ${num2} = ?`); break;
                case 'divide': num2 = r(2, 9); correctAnswer = r(2, 9); num1 = num2 * correctAnswer; setProblem(`${num1} Ã· ${num2} = ?`); break;
            }
        }

        // --- æ–°ç‰ˆæ··åˆé‹ç®—é‚è¼¯ ---
        function generateMixedProblem() {
            // 0: ç´”åŠ æ¸› (A Â± B Â± C)
            // 1: ä¹˜æ³•åœ¨å‰ (A x B Â± C)
            // 2: ä¹˜æ³•åœ¨å¾Œ (A Â± B x C)
            // 3: é™¤æ³•åœ¨å‰ (A Ã· B Â± C)
            // 4: é™¤æ³•åœ¨å¾Œ (A Â± B Ã· C)
            const type = Math.floor(Math.random() * 5);

            let n1, n2, n3, op2, midVal;

            if (type === 0) {
                // ç´”åŠ æ¸›ï¼šé›™ä½æ•¸
                n1 = r(20, 90); n2 = r(10, 50); n3 = r(10, 50);
                // éš¨æ©Ÿæ±ºå®šé‹ç®—ç¬¦
                let op1 = Math.random() > 0.5 ? '+' : '-';
                op2 = Math.random() > 0.5 ? '+' : '-';

                // ç¢ºä¿ä¸å‡ºç¾è² æ•¸
                if (op1 === '-' && n1 < n2) n1 += n2; // ä¿®æ­£ n1
                let val1 = (op1 === '+') ? n1 + n2 : n1 - n2;

                if (op2 === '-' && val1 < n3) {
                    // å¦‚æœç¬¬äºŒæ­¥æœƒè®Šæˆè² æ•¸ï¼Œæ”¹ç‚ºåŠ æ³•ï¼Œæˆ–è€…èª¿æ•´ n3
                    op2 = '+';
                }
                correctAnswer = (op2 === '+') ? val1 + n3 : val1 - n3;

                mixedProblem = {
                    text: `${n1} ${op1} ${n2} ${op2} ${n3} = ?`,
                    html: generateStepHTML('åªæœ‰åŠ æ¸›æ³•æ™‚ï¼Œå¾å·¦ç®—åˆ°å³',
                        `${n1} ${op1} ${n2} = ${val1}`,
                        `${val1} ${op2} ${n3} = ${correctAnswer}`)
                };

            } else if (type === 1) {
                // ä¹˜æ³•åœ¨å‰ï¼šå€‹ä½xå€‹ä½ Â± é›™ä½
                n1 = r(2, 9); n2 = r(2, 9); midVal = n1 * n2;
                n3 = r(10, 90);
                op2 = Math.random() > 0.5 ? '+' : '-';

                // ç¢ºä¿ä¸è² æ•¸
                if (op2 === '-' && midVal < n3) {
                    // äº¤æ›æ•¸å€¼æˆ–æ”¹ç‚ºåŠ æ³•ï¼Œé€™è£¡ç°¡å–®è™•ç†ï¼šæŠŠ n3 è®Šå°
                    n3 = r(1, midVal - 1);
                }
                correctAnswer = (op2 === '+') ? midVal + n3 : midVal - n3;

                mixedProblem = {
                    text: `${n1} Ã— ${n2} ${op2} ${n3} = ?`,
                    html: generateStepHTML('ç”±å·¦è€Œå³ï¼Œå…ˆç®—ä¹˜æ³•',
                        `${n1} Ã— ${n2} = ${midVal}`,
                        `${midVal} ${op2} ${n3} = ${correctAnswer}`)
                };

            } else if (type === 2) {
                // ä¹˜æ³•åœ¨å¾Œï¼šé›™ä½ Â± å€‹ä½xå€‹ä½
                n2 = r(2, 9); n3 = r(2, 9); midVal = n2 * n3; // å¾ŒåŠæ®µçš„å€¼
                n1 = r(10, 90); // å‰åŠæ®µé›™ä½æ•¸
                let op1 = Math.random() > 0.5 ? '+' : '-';

                if (op1 === '-' && n1 < midVal) {
                    n1 = midVal + r(5, 20); // ç¢ºä¿å¤ æ¸›
                }
                correctAnswer = (op1 === '+') ? n1 + midVal : n1 - midVal;

                mixedProblem = {
                    text: `${n1} ${op1} ${n2} Ã— ${n3} = ?`,
                    html: generateStepHTML('æ³¨æ„ï¼å…ˆä¹˜é™¤ï¼Œå¾ŒåŠ æ¸›',
                        `å…ˆç®—å¾Œé¢ï¼š ${n2} Ã— ${n3} = ${midVal}`,
                        `å†ç®—å‰é¢ï¼š ${n1} ${op1} ${midVal} = ${correctAnswer}`)
                };

            } else if (type === 3) {
                // é™¤æ³•åœ¨å‰ï¼šé›™ä½Ã·å€‹ä½ Â± é›™ä½
                n2 = r(2, 9); let q = r(2, 9); // å•†
                n1 = n2 * q; // è¢«é™¤æ•¸
                n3 = r(10, 90);
                op2 = Math.random() > 0.5 ? '+' : '-';

                if (op2 === '-' && q < n3) op2 = '+'; // å•†é€šå¸¸å¾ˆå°ï¼Œæ¸›æ³•å®¹æ˜“è² ï¼Œå¤šç”¨åŠ æ³•æˆ–ç¢ºä¿ n3 å¾ˆå°
                if (op2 === '-' && q > n3) correctAnswer = q - n3;
                else { op2 = '+'; correctAnswer = q + n3; }

                mixedProblem = {
                    text: `${n1} Ã· ${n2} ${op2} ${n3} = ?`,
                    html: generateStepHTML('ç”±å·¦è€Œå³ï¼Œå…ˆç®—é™¤æ³•',
                        `${n1} Ã· ${n2} = ${q}`,
                        `${q} ${op2} ${n3} = ${correctAnswer}`)
                };

            } else {
                // é™¤æ³•åœ¨å¾Œï¼šé›™ä½ Â± é›™ä½Ã·å€‹ä½
                n2 = r(2, 9); let q = r(2, 9); // å•†
                let divPart = n2 * q; // é€™éƒ¨åˆ†æ˜¯è¢«é™¤æ•¸ï¼Œä½†åœ¨ç®—å¼ä¸­å®ƒæ˜¯ä¸­é–“çš„æ•¸ (A Â± B Ã· C)
                // ä¿®æ­£è®Šæ•¸å‘½åä»¥ç¬¦åˆ A Â± B Ã· C æ ¼å¼ (n1 Â± n2 Ã· n3)
                // é€™è£¡ B = n2, C = n3, B/C = q
                let C = r(2, 9);
                let Q = r(2, 9);
                let B = C * Q;
                let A = r(10, 90); // é›™ä½æ•¸

                let op1 = Math.random() > 0.5 ? '+' : '-';
                if (op1 === '-' && A < Q) A = Q + r(5, 20);

                correctAnswer = (op1 === '+') ? A + Q : A - Q;

                mixedProblem = {
                    text: `${A} ${op1} ${B} Ã· ${C} = ?`,
                    html: generateStepHTML('çœ‹åˆ°é™¤è™Ÿè¦å…ˆç®—ï¼(å…ˆä¹˜é™¤å¾ŒåŠ æ¸›)',
                        `å…ˆç®—å¾Œé¢ï¼š ${B} Ã· ${C} = ${Q}`,
                        `å†ç®—å‰é¢ï¼š ${A} ${op1} ${Q} = ${correctAnswer}`)
                };
            }
            setProblem(mixedProblem.text);
        }

        function checkAnswer() {
            const userVal = document.getElementById('answer-input').value;
            if (userVal === '') { return; } // Silent return if empty on keypad enter
            const userAnswer = parseInt(userVal);
            const feedback = document.getElementById('mini-feedback');
            prepareExplanation();

            if (userAnswer === correctAnswer) {
                currentSessionScore += 10;
                let isNewRecord = false;
                if (currentSessionScore > highScores[currentMode]) {
                    highScores[currentMode] = currentSessionScore;
                    saveHighScores();
                    isNewRecord = true;
                }
                updateScoreUI();
                if (isNewRecord && currentSessionScore > 10) feedback.innerHTML = "<span style='color:#d0021b; font-size:1.3rem'>ğŸ† ç ´ç´€éŒ„å•¦ï¼å¤ªå¼·äº†ï¼</span>";
                else feedback.innerHTML = "<span style='color:green'>ğŸ‰ ç­”å°äº†ï¼ (+10åˆ†)</span>";

                // UI updates
                document.getElementById('keypad-enter').style.display = 'none'; // Hide Enter on keypad
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('explain-trigger').style.display = 'inline-block';
            } else {
                feedback.innerHTML = "<span style='color:red'>ğŸ’ª åŠ æ²¹ï¼Œçœ‹çœ‹è§£é¡Œæ€è·¯ï¼</span>";
                document.getElementById('explain-trigger').style.display = 'inline-block';
                document.getElementById('explain-trigger').innerText = "ğŸ’¡ é»æˆ‘çœ‹æ€éº¼ç®—";
                // Shake effect or visual feedback could be added here
            }
        }

        // Keypad Functions
        function appendNumber(num) {
            const input = document.getElementById('answer-input');
            if (input.value.length < 6) { // Limit length
                input.value += num;
            }
        }

        function backspace() {
            const input = document.getElementById('answer-input');
            input.value = input.value.slice(0, -1);
        }

        function clearInput() {
            document.getElementById('answer-input').value = '';
        }

        function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function setProblem(text) { document.getElementById('problem-text').innerText = text; }
        function resetUI() {
            document.getElementById('mini-feedback').innerHTML = "";
            document.getElementById('keypad-enter').style.display = 'flex'; // Restore Enter key
            document.getElementById('keypad-enter').style.gridColumn = 'span 3'; // Restore Grid span
            document.getElementById('check-btn').style.display = 'none'; // Keep original button hidden
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('explain-trigger').style.display = 'none';
            document.getElementById('explain-trigger').innerText = "ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯";
        }
        function generateStepHTML(hint, s1, s2) {
            return `<div style="color:#666; margin-bottom:10px;">ğŸ’¡ æç¤ºï¼š${hint}</div><div class="step-box"><strong>Step 1:</strong><br> ${s1}</div><div class="step-box" style="border-left-color: var(--success-color);"><strong>Step 2:</strong><br> ${s2}</div>`;
        }
        function prepareExplanation() {
            if (currentMode === 'mixed') currentExplanationHTML = mixedProblem.html;
            else {
                let logic = "";
                if (currentMode === 'add') logic = `æŠŠ ${num1} å’Œ ${num2} åˆèµ·ä¾†ã€‚`;
                if (currentMode === 'subtract') logic = `å¾ ${num1} æ‹¿èµ° ${num2}ã€‚`;
                if (currentMode === 'multiply') logic = `${num1} å€‹ ${num2} ç›¸åŠ ã€‚`;
                if (currentMode === 'divide') logic = `${num1} åˆ†æˆ ${num2} ä»½ã€‚`;
                currentExplanationHTML = `<p style="font-size:1.1rem;">${logic}</p><div class="step-box">ç­”æ¡ˆæ˜¯ï¼š ${correctAnswer}</div>`;
            }
        }

        function openModal() {
            document.getElementById('modal-body').innerHTML = currentExplanationHTML;
            const modal = document.getElementById('explanation-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('answer-input').blur();
        }
        function closeModal() {
            const modal = document.getElementById('explanation-modal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }
        function closeModalOutside(event) {
            if (event.target.id === 'explanation-modal') closeModal();
        }
    </script>
</body>

</html>