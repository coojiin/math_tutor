<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸æŒ‘æˆ° - ç©åˆ†æŒ‘æˆ°ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --accent-color: #9013fe;
            --success-color: #7ed321;
            --error-color: #d0021b;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 25px; /* ç¨å¾®æ¸›å°‘ padding ç•™çµ¦ä¸Šæ–¹è¨ˆåˆ†æ¿ */
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* è¨ˆåˆ†æ¿æ¨£å¼ */
        .score-board {
            display: flex;
            justify-content: space-between;
            background-color: #fdf8e4;
            border: 2px solid #f5a623;
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #d48e15;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }

        .score-val {
            font-size: 1.5rem;
            color: #333;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .mode-btn {
            background-color: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mode-btn span.high-score {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }

        .mode-btn.mixed-mode {
            grid-column: span 2;
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #fdf8ff;
        }

        .mode-btn:active { transform: scale(0.98); background-color: #eee; }
        .mode-btn.mixed-mode:active { background-color: var(--accent-color); color: white; }

        #practice-area { display: none; }

        .problem-display {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 10px 0 20px 0;
            color: #2c3e50;
            white-space: nowrap;
        }
        
        @media (max-width: 400px) { .problem-display { font-size: 2rem; } }

        input[type="number"] {
            width: 140px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 3px solid #ddd;
            border-radius: 12px;
            outline: none;
            -moz-appearance: textfield;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus { border-color: var(--primary-color); }

        .action-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 #d48e15;
            width: 100%;
            max-width: 280px;
        }

        .action-btn:active { transform: translateY(4px); box-shadow: none; }

        #mini-feedback {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            height: 30px; 
        }
        
        .explain-btn {
            background-color: #fff;
            border: 2px solid #999;
            color: #666;
            padding: 10px 20px;
            border-radius: 30px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: none; 
        }
        
        /* Modal æ¨£å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(3px);
        }

        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-content {
            background-color: #fff; width: 85%; max-width: 500px; max-height: 80vh;
            overflow-y: auto; border-radius: 20px; padding: 25px;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: left;
        }

        .modal-overlay.active .modal-content { transform: scale(1); }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px;
        }

        .modal-title { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); }
        .close-modal-btn {
            background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .step-box {
            background: #f9f9f9; padding: 15px; border-radius: 10px;
            border-left: 5px solid var(--accent-color); margin-bottom: 15px;
        }

        .back-btn {
            background: none; border: none; color: #999; margin-top: 20px;
            font-size: 1rem; text-decoration: underline; cursor: pointer;
        }

        /* æ…¶ç¥å‹•ç•« */
        @keyframes pop { 50% { transform: scale(1.2); } }
        .new-record-anim { animation: pop 0.3s ease-in-out; color: #d0021b; }

    </style>
</head>
<body>

<div class="container">
    <!-- é¦–é é¸å–® -->
    <div id="home-menu">
        <h1>ğŸ† æ•¸å­¸æŒ‘æˆ°è³½</h1>
        <p>æ‰“ç ´ç´€éŒ„ï¼Œæˆç‚ºæ•¸å­¸å°åšå£«ï¼</p>
        <div class="menu-grid">
            <button class="mode-btn" onclick="startPractice('add')">
                â• åŠ æ³•
                <span class="high-score" id="score-add">ç´€éŒ„: 0</span>
            </button>
            <button class="mode-btn" onclick="startPractice('subtract')">
                â– æ¸›æ³•
                <span class="high-score" id="score-subtract">ç´€éŒ„: 0</span>
            </button>
            <button class="mode-btn" onclick="startPractice('multiply')">
                âœ–ï¸ ä¹˜æ³•
                <span class="high-score" id="score-multiply">ç´€éŒ„: 0</span>
            </button>
            <button class="mode-btn" onclick="startPractice('divide')">
                â— é™¤æ³•
                <span class="high-score" id="score-divide">ç´€éŒ„: 0</span>
            </button>
            <button class="mode-btn mixed-mode" onclick="startPractice('mixed')">
                ğŸš€ æ··åˆé‹ç®—æŒ‘æˆ°
                <span class="high-score" id="score-mixed">ç´€éŒ„: 0</span>
            </button>
        </div>
    </div>

    <!-- ç·´ç¿’å€ -->
    <div id="practice-area">
        <!-- è¨ˆåˆ†æ¿ -->
        <div class="score-board">
            <div class="score-item">
                <span>âœ¨ æœ¬æ¬¡å¾—åˆ†</span>
                <span class="score-val" id="current-score">0</span>
            </div>
            <div class="score-item" style="text-align:right;">
                <span>ğŸ† æœ€é«˜ç´€éŒ„</span>
                <span class="score-val" id="best-score">0</span>
            </div>
        </div>

        <h3 id="mode-title" style="color:#999; margin:0; font-size:1rem;">ç·´ç¿’æ¨¡å¼</h3>
        
        <div class="problem-display" id="problem-text"></div>

        <div>
            <input type="number" id="answer-input" placeholder="?" pattern="[0-9]*" inputmode="numeric">
        </div>

        <div id="mini-feedback"></div>

        <button class="action-btn" id="check-btn" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ</button>
        
        <button class="explain-btn" id="explain-trigger" onclick="openModal()">ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯</button>

        <button class="action-btn" id="next-btn" onclick="generateProblem()" style="display:none; background-color: var(--primary-color);">ä¸‹ä¸€é¡Œ âœ</button>

        <br>
        <button class="back-btn" onclick="goHome()">çµæŸç·´ç¿’ (å›ä¸»é¸å–®)</button>
    </div>
</div>

<!-- å½ˆå‡ºè¦–çª— (Modal) -->
<div id="explanation-modal" class="modal-overlay" onclick="closeModalOutside(event)">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">ğŸ“ è§£é¡Œæ€è·¯</span>
            <button class="close-modal-btn" onclick="closeModal()">âœ•</button>
        </div>
        <div id="modal-body"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="action-btn" onclick="closeModal()" style="padding: 10px 30px; font-size: 1rem; width:auto;">æˆ‘çŸ¥é“äº†ï¼</button>
        </div>
    </div>
</div>

<script>
    let currentMode = '';
    let num1 = 0, num2 = 0;
    let mixedProblem = null;
    let correctAnswer = 0;
    let currentExplanationHTML = '';
    
    // ç©åˆ†è®Šæ•¸
    let currentSessionScore = 0;
    let highScores = {
        'add': 0, 'subtract': 0, 'multiply': 0, 'divide': 0, 'mixed': 0
    };

    // åˆå§‹åŒ–ï¼šå¾ localStorage è®€å–åˆ†æ•¸
    window.onload = function() {
        loadHighScores();
        updateMenuScores();
    };

    function loadHighScores() {
        const saved = localStorage.getItem('mathTutorHighScores');
        if (saved) {
            highScores = JSON.parse(saved);
        }
    }

    function saveHighScores() {
        localStorage.setItem('mathTutorHighScores', JSON.stringify(highScores));
    }

    function updateMenuScores() {
        for (const [mode, score] of Object.entries(highScores)) {
            const el = document.getElementById(`score-${mode}`);
            if(el) el.innerText = `ç´€éŒ„: ${score}`;
        }
    }

    function startPractice(mode) {
        currentMode = mode;
        currentSessionScore = 0; // é‡ç½®ç•¶å‰åˆ†æ•¸
        
        document.getElementById('home-menu').style.display = 'none';
        document.getElementById('practice-area').style.display = 'block';
        
        const titles = {
            'add': 'åŠ æ³•ç·´ç¿’', 'subtract': 'æ¸›æ³•ç·´ç¿’',
            'multiply': 'ä¹˜æ³•ç·´ç¿’', 'divide': 'é™¤æ³•ç·´ç¿’',
            'mixed': 'æ··åˆé‹ç®—'
        };
        document.getElementById('mode-title').innerText = titles[mode];
        
        updateScoreUI(); // æ›´æ–°ä¸Šæ–¹è¨ˆåˆ†æ¿
        generateProblem();
    }

    function updateScoreUI() {
        document.getElementById('current-score').innerText = currentSessionScore;
        document.getElementById('best-score').innerText = highScores[currentMode];
        
        // å¦‚æœç ´ç´€éŒ„ï¼Œæ”¹è®Šé¡è‰²
        if (currentSessionScore > highScores[currentMode] && highScores[currentMode] > 0) {
            document.getElementById('current-score').classList.add('new-record-anim');
        } else {
            document.getElementById('current-score').classList.remove('new-record-anim');
        }
    }

    function goHome() {
        document.getElementById('practice-area').style.display = 'none';
        document.getElementById('home-menu').style.display = 'block';
        updateMenuScores(); // å›é¦–é æ™‚æ›´æ–°æŒ‰éˆ•ä¸Šçš„åˆ†æ•¸
        resetUI();
    }

    function generateProblem() {
        resetUI();
        const input = document.getElementById('answer-input');
        input.value = '';
        input.focus();

        if (currentMode === 'mixed') {
            generateMixedProblem();
        } else {
            generateBasicProblem();
        }
    }

    function generateBasicProblem() {
        // æ ¹æ“šæ¨¡å¼ç”¢ç”Ÿé¡Œç›® (èˆ‡ä¹‹å‰ç›¸åŒ)
        switch(currentMode) {
            case 'add':
                num1 = r(10, 99); num2 = r(10, 99); 
                correctAnswer = num1 + num2;
                setProblem(`${num1} + ${num2} = ?`);
                break;
            case 'subtract':
                num1 = r(10, 99); num2 = r(1, num1-1);
                correctAnswer = num1 - num2;
                setProblem(`${num1} - ${num2} = ?`);
                break;
            case 'multiply':
                num1 = r(2, 9); num2 = r(2, 9);
                correctAnswer = num1 * num2;
                setProblem(`${num1} Ã— ${num2} = ?`);
                break;
            case 'divide':
                num2 = r(2, 9); correctAnswer = r(2, 9);
                num1 = num2 * correctAnswer;
                setProblem(`${num1} Ã· ${num2} = ?`);
                break;
        }
    }

    function generateMixedProblem() {
        // æ··åˆé‹ç®—é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ)
        const type = Math.floor(Math.random() * 4);
        let n1, n2, n3;
        if (type === 0) { 
            n2 = r(2,9); n3 = r(2,9); n1 = r(1,20);
            correctAnswer = n1 + (n2 * n3);
            mixedProblem = { text: `${n1} + ${n2} Ã— ${n3} = ?`, html: generateStepHTML('å…ˆç®—ä¹˜æ³•', `${n2} Ã— ${n3} = ${n2*n3}`, `${n1} + ${n2*n3} = ${correctAnswer}`) };
        } else if (type === 1) {
            n2 = r(2,5); n3 = r(2,5); let m = n2 * n3; n1 = m + r(5,20);
            correctAnswer = n1 - m;
            mixedProblem = { text: `${n1} - ${n2} Ã— ${n3} = ?`, html: generateStepHTML('å…ˆç®—ä¹˜æ³•', `${n2} Ã— ${n3} = ${m}`, `${n1} - ${m} = ${correctAnswer}`) };
        } else if (type === 2) {
            n3 = r(2,9); let q = r(2,9); n2 = n3 * q; n1 = r(1,20);
            correctAnswer = n1 + q;
            mixedProblem = { text: `${n1} + ${n2} Ã· ${n3} = ?`, html: generateStepHTML('å…ˆç®—é™¤æ³•', `${n2} Ã· ${n3} = ${q}`, `${n1} + ${q} = ${correctAnswer}`) };
        } else {
            n3 = r(2,9); let q = r(2,9); n2 = n3 * q; n1 = q + r(5,20);
            correctAnswer = n1 - q;
            mixedProblem = { text: `${n1} - ${n2} Ã· ${n3} = ?`, html: generateStepHTML('å…ˆç®—é™¤æ³•', `${n2} Ã· ${n3} = ${q}`, `${n1} - ${q} = ${correctAnswer}`) };
        }
        setProblem(mixedProblem.text);
    }

    function checkAnswer() {
        const userVal = document.getElementById('answer-input').value;
        if(userVal === '') { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
        const userAnswer = parseInt(userVal);
        const feedback = document.getElementById('mini-feedback');
        
        prepareExplanation();

        if (userAnswer === correctAnswer) {
            // ç­”å°ï¼šåŠ  10 åˆ†
            currentSessionScore += 10;
            
            // æª¢æŸ¥æ˜¯å¦ç ´ç´€éŒ„
            let isNewRecord = false;
            if (currentSessionScore > highScores[currentMode]) {
                highScores[currentMode] = currentSessionScore;
                saveHighScores(); // å„²å­˜åˆ° localStorage
                isNewRecord = true;
            }
            
            updateScoreUI();

            if (isNewRecord && currentSessionScore > 10) { // ç¬¬ä¸€é¡Œä¸ç®—ç ´ç´€éŒ„
                feedback.innerHTML = "<span style='color:#d0021b; font-size:1.3rem'>ğŸ† ç ´ç´€éŒ„å•¦ï¼å¤ªå¼·äº†ï¼</span>";
            } else {
                feedback.innerHTML = "<span style='color:green'>ğŸ‰ ç­”å°äº†ï¼ (+10åˆ†)</span>";
            }

            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            document.getElementById('explain-trigger').style.display = 'inline-block'; 
        } else {
            // ç­”éŒ¯
            feedback.innerHTML = "<span style='color:red'>ğŸ’ª åŠ æ²¹ï¼Œçœ‹çœ‹è§£é¡Œæ€è·¯ï¼</span>";
            document.getElementById('explain-trigger').style.display = 'inline-block';
            document.getElementById('explain-trigger').innerText = "ğŸ’¡ é»æˆ‘çœ‹æ€éº¼ç®—";
        }
    }

    // --- è¼”åŠ©å‡½æ•¸ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
    function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function setProblem(text) { document.getElementById('problem-text').innerText = text; }
    function resetUI() {
        document.getElementById('mini-feedback').innerHTML = "";
        document.getElementById('check-btn').style.display = 'inline-block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('explain-trigger').style.display = 'none';
        document.getElementById('explain-trigger').innerText = "ğŸ’¡ æŸ¥çœ‹è§£é¡Œæ€è·¯";
    }
    function generateStepHTML(hint, s1, s2) {
        return `<div style="color:#666; margin-bottom:10px;">ğŸ’¡ æç¤ºï¼š${hint}</div><div class="step-box"><strong>Step 1:</strong><br> ${s1}</div><div class="step-box" style="border-left-color: var(--success-color);"><strong>Step 2:</strong><br> ${s2}</div>`;
    }
    function prepareExplanation() {
        if (currentMode === 'mixed') {
            currentExplanationHTML = mixedProblem.html;
        } else {
            let logic = "";
            if(currentMode === 'add') logic = `æŠŠ ${num1} å’Œ ${num2} åˆèµ·ä¾†ã€‚`;
            if(currentMode === 'subtract') logic = `å¾ ${num1} æ‹¿èµ° ${num2}ã€‚`;
            if(currentMode === 'multiply') logic = `${num1} å€‹ ${num2} ç›¸åŠ ã€‚`;
            if(currentMode === 'divide') logic = `${num1} åˆ†æˆ ${num2} ä»½ã€‚`;
            currentExplanationHTML = `<p style="font-size:1.1rem;">${logic}</p><div class="step-box">ç­”æ¡ˆæ˜¯ï¼š ${correctAnswer}</div>`;
        }
    }

    // Modal æ§åˆ¶
    function openModal() {
        document.getElementById('modal-body').innerHTML = currentExplanationHTML;
        const modal = document.getElementById('explanation-modal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
        document.getElementById('answer-input').blur();
    }
    function closeModal() {
        const modal = document.getElementById('explanation-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
    function closeModalOutside(event) {
        if (event.target.id === 'explanation-modal') closeModal();
    }

</script>
</body>
</html>
